# 混合内容--资源404的最大原因


## 0x00 前言

事情的起因是这样的，这阵子因为疫情在家憋得慌，就搞了个Hugo博客解解闷。花了几天时间之后发现了一个更加好看的主题，于是决定把原来的主题给替换掉，又折腾了一天，本以为大功告成，却发现原先博文的图片全部加载不出来了！打开chrome的console看了一下，报错如下。

![](https://ptbuff-1301738307.cos.ap-guangzhou.myqcloud.com/2020-04-03-混合内容-1.jpg)

基本上就是说我从在一个https页面中加载了一个http的资源，浏览器觉得这个亚子不安全，就拒绝了加载http资源。看来这就是图片加载失败的原因了，不过有两个疑问：

+ 上图中的console提示说加载了5张图，有两张图被警告，但是允许加载，剩下三张直接拒绝了加载，当时就在想这咋还能双标
+ 上一次主题我所有http图片均可以在https下加载出来，咋换了个主题就不行了

当时没有多想，就觉得非要证书就给吧，于是把图存到了SM.MS图床，用上了带https的外链。这两天在研究博客中嵌入视频和音频的时候，这个问题又冒出来了。因为目前没有可以放视音频的床，从第三方网站爬出来的外链和我七牛云云存储桶里的外链都是没有带https的，于是chrome又把我的所有资源都干掉了。鉴于给自己的云存储桶加证书的费用实在太高，以及视音频文件体积过大怕流量走的太快钱包受不了，我决心认认真真研究一下上面那两个问题，试图做到在一切情况下都可以默认加载http资源的效果。但是一番研究之后，发现很遗憾这是不可能的，不过还是出来分享一下说了解到的信息吧。

## 0x01 概念简介

### 产生的原因

当通过https访问的某个页面或网站中包含了http资源，就会在https网页中加载这些http资源，而这些http资源就被叫做https混合内容（Mixed Content）。而凡是在https页面中带有http链接方式的图片、视频、音频、超链接，Iframe，CSS 、JavaScript、XHR、Font等资源，都可看作是https混合内容。

### 类型

混合内容的分类是根据http资源的风险级别程度的性质来决定的，目前主要有两种类型的混合内容：

+ 混合被动内容（Mixed passive content）：也叫混合显示(Mixed Display)，它们是低风险的内容，例如图片； 混合被动内容虽然不是那么的危险，但依然会破坏页面的完整性。在某些情况下，攻击者可以通过在图片中插入信息来玩弄受害者，可能导致钓鱼攻击的发生。

+ 混合主动内容（Mixed active conttent）：也叫作混合脚本（Mixed Scripting)，它们是高风险的内容，常见的有JavaScript脚本。混合主动内容是威胁的真正来源。一个不被加密的JavaScript文件的引用，可能会被主动攻击者劫持，并用来获取对页面的完全控制，已经使用受害者的身份在网站上执行任意的动作。对于其他危险的资源类型也是如此，包括：HTML(框架）、CSS、Flash和Java应用程序等。

### 处理方式

https属于加密传输方式，比http传输方式更加安全可靠，不易被篡改和劫持。为了确保https页面加密的一致性和安全性，各大主流浏览器自然希望其页面中的资源也应该采用https方式进行加载。很显然这个想法过于天真，再过几年也很难将https全面普及，自然也不好将所有混合内容的资源全部拦截，只默认拦截其中一部分类型。以下是我查到的资料的说法：

>现代浏览器(Chrome、Firefox、Safari、Microsoft Edge)，基本上都遵守了 W3C 的 Mixed Content 规范，将 Mixed Content 分为Optionally-blockable 和 Blockable 两类。
>
>Optionally-blockable 类 ：包含那些危险较小，即使被中间人篡改也无大碍的资源。现代浏览器默认会加载这类资源，同时会在控制台打印警告信息。这类资源包括：
>
>+ 通过 &lt;img&gt; 标签加载的图片（包括 SVG 图片）
>+ 通过 &lt;video&gt; / &lt;audio&gt; 和 &lt;source&gt; 标签加载的视频或音频
>+ 预读的（Prefetched）资源
>
>除此之外所有的混合内容都是 Blockable，浏览器必须禁止加载这类资源。所以现代浏览器中，对于https页面中的 JavaScript、CSS 等http资源，一律不加载，直接在控制台打印错误信息。

不过就我个人的测试结果来看，和上述结论有一点不一样，就是通过&lt;video&gt; / &lt;audio&gt; 和 &lt;source&gt; 标签里的视频或音频无法加载，甚至安全要求最低的微信浏览器都无法加载。

### console样式

混合被动资源的警告样式。

![](https://ptbuff-1301738307.cos.ap-guangzhou.myqcloud.com/2020-04-03-混合内容-2.jpg)

混合主动资源的错误样式。

![](https://ptbuff-1301738307.cos.ap-guangzhou.myqcloud.com/2020-04-03-混合内容-3.jpg)

## 0x02 问题分析

了解了上述概念之后，就可以对前言中的两个疑问进行排查了。

首先把旧主题配置到另一个GitHub账号的GitHub Pages上，访问时图片正常显示，打开源码找到&lt;img&gt;标签，显示如下

```html
<p>
<img src="http://XXXXX/image-20200411144334818.png" 
alt="image-20200411144334818">
</p>
```

而新主题的的源码下，&lt;img&gt;标签则是

```html
<p>
<img  class="lazyload"
      src="/svg/loading.small.min.svg"
      data-sizes="auto"
      data-srcset="http://XXXXX/image-20200411144334818.png,  1.5x,  2x"
      data-src=""
      alt=""
      title="" />
</p>
```

可以发现旧主体为直接引用图片地址，**属于混合被动内容**。而新主题使用了**lazysizes.js**这个第三方库来实现更多的图片展示样式和懒加载，这也就造成了我们这个http图片资源是通过js文件来加载的，就变成了**混合主动内容**，于是被浏览器默认拒绝加载。这就搞清楚了前言中提到两个问题，因为我第一个问题中，新主题唯一可以显示的两张http图片也是我直接采用&lt;img&gt;标签引用的，所以没有被拒绝加载。

## 0x03 解决方案

### 原生方式引用

如果你只需要在博客中引入图片，且对样式和加载方式没有其他要求的情况下，直接使用&lt;img&gt;标签引用http图片即可避免无法加载的情况。缺点就是虽然你域名是https的，但是页面加载了http资源的情况下，浏览器依旧会显示**不安全**字样，以及http的资源容易遭受攻击，理论上存在安全问题，这一点之后会写一篇文章详细介绍不安全在哪。优点也很明显，就是图床的钱再也不用出了，七牛的10G桶足够应对几年的使用。

### 多域名组合

这种方式其实对博客来说没有什么很大的意义，但是在一些稍微大型一点的网站内很常见，顺带就介绍一下。基本操作方式就是，准备两个域名，一个http没证书，一个https有证书，在没有引入http资源的页面使用有证书的域名，在需要引入http资源的页面，切换成另一个没证书的域名。缺点非常明显，对于博客来说这么做工作量过大，尤其是自动生成的静态博客，后期一个个去修改链接，还需要生成两套静态文件组合，实在是过于麻烦。优点我还真的是一个都想不到，最多就是让不安全的页面少一点吧。

### 全站https

如果你博客存放的图片、视频和音频整体体积不大的话，建议花点小钱把这些资源全部变成https的外链。https终将被普及，早用早舒服。如果只放图片的话，无损压缩一下，一个月放在腾讯云只花10块钱不到。当然如果你**不差钱**，这就是最方便，最快捷的选择。

### 弃用证书

这种方式推荐给对视频、音频和高画质图片需求量大，整体文件体积大的朋友。庞大的资源全部放在带https的桶里面，资金负担比较大，一般个人是没办法承受的，所以只能把证书弃用。这样就可以利用N个七牛账号，分开存放资源，做到永久白嫖。
